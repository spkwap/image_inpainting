<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Image</title>
    <style>
        #canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>Upload Image and Draw Mask</h1>
    <form id="upload-form" method="POST" enctype="multipart/form-data">
        <label for="image">Upload Image:</label>
        <input type="file" id="image" name="image" required><br><br>

        <button type="submit">Upload Image</button>
    </form>

    <br><br>
    <canvas id="canvas" width="512" height="512"></canvas><br>
    <button id="clear-btn">Clear Mask</button><br><br>
    <button id="submit-btn">Submit</button>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const imageInput = document.getElementById('image');
        const submitBtn = document.getElementById('submit-btn');
        const clearBtn = document.getElementById('clear-btn');

        let isDrawing = false;
        let image = new Image();

        // Load and display image on canvas
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                image.onload = function() {
                    ctx.drawImage(image, 0, 0, 512, 512);
                };
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Draw white mask on canvas
        canvas.addEventListener('mousedown', () => { isDrawing = true; });
        canvas.addEventListener('mouseup', () => { isDrawing = false; });
        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                ctx.globalCompositeOperation = 'source-over'; // Prevent blending
                ctx.fillStyle = 'rgb(255,255,255)'; // Ensure pure white
                ctx.fillRect(x, y, 10, 10);
            }
        });

        // Clear the canvas and reload the image
        clearBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0, 512, 512);
        });

        // Ensure mask has only pure black or white
        function correctMask() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];

                // If pixel is dark (less than or equal to 20,20,20), make it pure black
                if (r <= 20 && g <= 20 && b <= 20) {
                    data[i] = 0;   // Red
                    data[i + 1] = 0; // Green
                    data[i + 2] = 0; // Blue
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        // Submit the image with the mask
        submitBtn.addEventListener('click', async function() {
            // Correct the mask before submitting
            correctMask();

            // Convert canvas to image data
            const modifiedImageData = canvas.toDataURL('image/png');

            // Convert data URL to blob
            const modifiedImageBlob = await fetch(modifiedImageData).then(res => res.blob());

            // Create FormData to send to the server
            const formData = new FormData();
            formData.append('image', modifiedImageBlob, 'input_image.png');

            // Send request to the server
            const response = await fetch('/inpaint', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const resultImage = await response.blob();
                const imgURL = URL.createObjectURL(resultImage);
                const imgElement = document.createElement('img');
                imgElement.src = imgURL;
                document.body.appendChild(imgElement);
            } else {
                alert('Error occurred during inpainting.');
            }
        });
    </script>
</body>
</html>
